---
import type { MDXInstance } from 'astro'
import NavigationItem from './NavigationItem.astro'
import type { SEO } from '../data/seo.js'

export interface Page extends SEO {
    navigation?: {
        order: number
    }
}

export interface Entry {
    title: string
    url: string
    order: number
    parentKey?: string
    children?: Entry[]
}

function getParentKey(url: string) {
    const segments = url.split('/')

    if (segments.length === 1) return undefined
    return segments.slice(0, segments.length -1 ).join('/')
}

const allPages = await Astro.glob<Page>('/src/pages/**/*.mdx')

function findNavigationEntries(nodes: MDXInstance<Page>[] = [], key = '') {
    let pages: Entry[] = []

    for (const entry of nodes) {
        if (entry.frontmatter.navigation) {
            const nav = entry.frontmatter.navigation
            const parent = getParentKey(entry.url!)
            if (!key && !parent || parent === key) {
                pages.push({
                    ...nav,
                    title: entry.frontmatter.title,
                    url: entry.url!,
                })
            }
        }
    }

    return pages.sort((a, b) => a.order - b.order)
        .map(entry => {
            if (entry.url) {
                entry.children = findNavigationEntries(nodes, entry.url)
            }

            return entry
        })
}

const entries = findNavigationEntries(allPages)
---

<ul>
    {entries.map(entry => (<NavigationItem {...entry} />))}
</ul>